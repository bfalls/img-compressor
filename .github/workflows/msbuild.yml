name: msbuild

on:
  pull_request:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: [self-hosted, windows, cuda]
    if: >
      github.event_name != 'pull_request'
      || github.event.pull_request.head.repo.fork == false

    steps:
      - uses: actions/checkout@v4

      - name: Show runner
        run: |
          echo "Runner name: $RUNNER_NAME"
          echo "Runner OS:   $RUNNER_OS"
          echo "Runner arch: $RUNNER_ARCH"

      - name: Setup MSVC environment (x64)
        shell: pwsh
        run: |
          $vswhere = "${env:ProgramFiles(x86)}\Microsoft Visual Studio\Installer\vswhere.exe"
          if (!(Test-Path $vswhere)) { throw "vswhere not found at $vswhere" }

          $vsPath = & $vswhere -latest -products * -requires Microsoft.VisualStudio.Component.VC.Tools.x86.x64 -property installationPath
          if (!$vsPath) { throw "Visual Studio with C++ tools not found" }

          $vsDevCmd = Join-Path $vsPath "Common7\Tools\VsDevCmd.bat"
          if (!(Test-Path $vsDevCmd)) { throw "VsDevCmd.bat not found at $vsDevCmd" }

          # Run VsDevCmd and capture the resulting environment for this Actions job
          cmd /c "`"$vsDevCmd`" -arch=x64 -host_arch=x64 && set" |
            ForEach-Object {
              if ($_ -match "^(.*?)=(.*)$") {
                "$($matches[1])=$($matches[2])" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8
              }
            }

      # Install CUDA Toolkit so MSBuild can import CUDA 13.0.props/targets and run nvcc.
      - name: Install CUDA Toolkit 13.0 (hosted runners only)
        if: runner.environment != 'self-hosted'
        uses: Jimver/cuda-toolkit@v0.2.29
        with:
          cuda: "13.0.2"
          method: "network"

      - name: Verify toolchain
        shell: pwsh
        run: |
          Write-Host "CUDA_PATH=$env:CUDA_PATH"
          where.exe cl
          where.exe msbuild
          where.exe nvcc
          nvcc --version
          cl

      # Sanity check: make sure the VS integration files exist.
      - name: Verify CUDA Build Customizations exist
        if: runner.environment != 'self-hosted'
        shell: pwsh
        run: |
          Write-Host "CUDA_PATH=$env:CUDA_PATH"
          if (-not (Test-Path "$env:CUDA_PATH\bin\nvcc.exe")) {
            throw "nvcc.exe not found under CUDA_PATH. CUDA install failed."
          }

          # Look for the versioned .props/.targets under the VS MSBuild BuildCustomizations folder
          $paths = @(
            "C:\Program Files\Microsoft Visual Studio\2022\Enterprise\MSBuild\Microsoft\VC\v170\BuildCustomizations",
            "C:\Program Files\Microsoft Visual Studio\2022\Professional\MSBuild\Microsoft\VC\v170\BuildCustomizations",
            "C:\Program Files\Microsoft Visual Studio\2022\Community\MSBuild\Microsoft\VC\v170\BuildCustomizations",
            "C:\Program Files (x86)\Microsoft Visual Studio\2022\Enterprise\MSBuild\Microsoft\VC\v170\BuildCustomizations",
            "C:\Program Files (x86)\Microsoft Visual Studio\2022\Professional\MSBuild\Microsoft\VC\v170\BuildCustomizations",
            "C:\Program Files (x86)\Microsoft Visual Studio\2022\Community\MSBuild\Microsoft\VC\v170\BuildCustomizations"
          )

          $bc = $paths | Where-Object { Test-Path $_ } | Select-Object -First 1
          if (-not $bc) { throw "VS BuildCustomizations folder not found on runner." }

          Write-Host "VS BuildCustomizations folder: $bc"
          if (-not (Test-Path "$bc\CUDA 13.0.props")) { throw "Missing: $bc\CUDA 13.0.props" }
          if (-not (Test-Path "$bc\CUDA 13.0.targets")) { throw "Missing: $bc\CUDA 13.0.targets" }

          & "$env:CUDA_PATH\bin\nvcc.exe" --version

      - name: Bootstrap vcpkg
        uses: lukka/run-vcpkg@v11
        with:
          vcpkgDirectory: ${{ github.workspace }}\vcpkg
          vcpkgGitURL: https://github.com/microsoft/vcpkg.git
          runVcpkgInstall: true
          doNotCache: true

      - name: Add MSBuild to PATH
        uses: microsoft/setup-msbuild@v2

      - name: Restore & Build
        run: |
          msbuild img-compressor.sln /m /p:Configuration=Release /p:Platform=x64 /v:m
